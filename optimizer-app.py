import math
import collections
import datetime
import os
import redis  # <<< –ù–û–í–û–ï: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è Redis
import json   # <<< –ù–û–í–û–ï: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º JSON –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö

from flask import Flask, request, jsonify
from ortools.sat.python import cp_model

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ Flask ---
app = Flask(__name__)

# --- –ù–û–í–û–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis ---
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏, —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
# –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.
try:
    redis_client = redis.Redis(
        host=os.environ.get('REDIS_HOST', 'localhost'),
        port=int(os.environ.get('REDIS_PORT', 6379)),
        db=0,
        decode_responses=True  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã –∏–∑ –±–∞–π—Ç–æ–≤ –≤ —Å—Ç—Ä–æ–∫–∏ UTF-8
    )
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    redis_client.ping()
    print("‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis.")
except redis.exceptions.ConnectionError as e:
    redis_client = None
    print(f"‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Redis. –°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è. –û—à–∏–±–∫–∞: {e}")
# ------------------------------------------------

# ==============================================================================
#  –ù–ê–ß–ê–õ–û –ö–û–î–ê –ò–ó –í–ê–®–ï–ì–û –°–ö–†–ò–ü–¢–ê (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ –≤–∏–¥–µ —Ñ—É–Ω–∫—Ü–∏–∏)
# ==============================================================================

# ... (–≤–µ—Å—å –≤–∞—à –∫–æ–¥ —Å tech_map_data, machines_available, –∏ —Ç.–¥. –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
# ... —è –µ–≥–æ —Å–∫—Ä—ã–ª –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏, –Ω–æ –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–¥–µ—Å—å ...
tech_map_data = {
    # –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å–æ–≥–ª–∞—Å–Ω–æ —Å–ø–∏—Å–∫—É –æ—Ç 20.05.2024
    # –î–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏

    # --- –¢–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ —à–∞–±–ª–æ–Ω) ---
    # "–ù–∞–∑–≤–∞–Ω–∏–µ": {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:17:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"},

    "–•–ª–µ–± ¬´–§–æ—Ä–º–æ–≤–æ–π¬ª":             {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:12:00", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:45:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:30:00"},
    "–•–ª–µ–± ¬´–°–µ–º–µ–π–Ω—ã–π¬ª":             {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:17:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"},
    "–¢–æ—Å—Ç–æ–≤—ã–π —Ö–ª–µ–± –Ω–∞—Ä–µ–∑–∞–Ω–Ω—ã–π":    {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:22:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–°—ç–Ω–¥–≤–∏—á –ü–∞–Ω–∏–Ω–∏ / –°—ç–Ω–¥–≤–∏—á –ü–∞–Ω–∏–Ω–∏ —Å –∫—É–Ω–∂—É—Ç–æ–º": {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:22:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "0:45:00"}, # –í–∑—è—Ç—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç "–°—ç–Ω–¥–≤–∏—á"
    "–ë–∞–≥–µ—Ç ¬´–ù–æ–≤—ã–π¬ª":               {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:25:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:15:00"},
    "–ë—É–ª–æ—á–∫–∞ –¥–ª—è –≥–∞–º–±—É—Ä–≥–µ—Ä–∞ –±–æ–ª—å—à–∞—è / —Å –∫—É–Ω–∂—É—Ç–æ–º": {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:22:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "0:45:00"},
    "–°—ç–Ω–¥–≤–∏—á —Å–æ–ª–æ–¥–æ–≤—ã–π —Å —Å–µ–º–µ—á–∫–∞–º–∏ (–ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)": {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:22:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "0:45:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–ë—É–ª–æ—á–∫–∞ –¥–ª—è —Ö–æ—Ç-–¥–æ–≥–∞/–≥–∞–º–±—É—Ä–≥–µ—Ä–∞": {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:22:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "0:45:00"},
    "–•–æ—Ç-–¥–æ–≥/–ì–∞–º–±—É—Ä–≥–µ—Ä —Å–æ–ª–æ–¥–æ–≤—ã–π —Å —Å–µ–º–µ—á–∫–∞–º–∏": {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:22:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "0:45:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–°—ç–Ω–¥–≤–∏—á —Å–æ–ª–æ–¥–æ–≤—ã–π —Å —Å–µ–º–µ—á–∫–∞–º–∏ (–≤—Ç–æ—Ä–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)": {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:22:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "0:45:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–ß–∏–∞–±–∞—Ç—Ç–∞":                    {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:25:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:15:00"},
    "–•–ª–µ–± ¬´–ü–∞—Ä—Ç–∏—è –±–µ–∑–¥—Ä–æ–∂–∂–µ–≤–æ–π¬ª":  {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:20:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:16:30", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"}, # –ê–Ω–∞–ª–æ–≥ "–¢–∞—Ä—Ç–∏–Ω –±–µ–∑–¥—Ä–æ–∂–∂–µ–≤–æ–π"
    "–°—ç–Ω–¥–≤–∏—á –ó–µ—Ä–Ω–æ–≤–æ–π":            {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:22:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "0:45:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–ù–µ–º–µ—Ü–∫–∏–π —Ö–ª–µ–±":               {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:17:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"},
    "–ü–∞–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ —Å—É—Ö–∞—Ä–∏":         {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:15:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:00:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:00:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:40:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:20:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–•–ª–µ–± ¬´–ó–µ—Ä–Ω–æ–≤–æ–π¬ª":             {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:25:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:15:00"},
    "–ë—Ä–∏–æ—à—å":                      {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:30:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:20:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "0:45:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–õ–µ–ø–µ—à–∫–∞ —Å —Å—ã—Ä–æ–º –∏ –ª—É–∫–æ–º":     {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:20:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:15:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "0:30:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–õ–µ–ø–µ—à–∫–∞ —Å –∫—É–Ω–∂—É—Ç–æ–º":          {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:20:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:15:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "0:30:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–•–ª–µ–± ¬´–°–æ–ª–æ–¥–æ–≤—ã–π —Å —Å–µ–º–µ—á–∫–∞–º–∏¬ª": {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:18:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–•–ª–µ–± —Å–æ–ª–æ–¥–æ–≤—ã–π —Å —Å–µ–º–µ—á–∫–∞–º–∏ –Ω–∞—Ä–µ–∑–∞–Ω–Ω—ã–π": {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:18:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–•–ª–µ–± ¬´–°–ø–æ—Ä—Ç –ê–∫—Ç–∏–≤¬ª":          {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:18:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–ó–µ—Ä–Ω–æ–≤–æ–π —Å–æ–ª–æ–¥–æ–≤—ã–π —Ö–ª–µ–± –Ω–∞—Ä–µ–∑–∞–Ω–Ω—ã–π": {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:25:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:15:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–•–ª–µ–± ¬´–ó–µ—Ä–Ω–æ–≤–æ–π —Å–æ–ª–æ–¥–æ–≤—ã–π¬ª":   {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:25:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:15:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–ì—Ä–µ—á–∏—à–Ω—ã–π —Ö–ª–µ–± –Ω–∞—Ä–µ–∑–∞–Ω–Ω—ã–π":   {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:17:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–ö—É–∫—É—Ä—É–∑–Ω—ã–π —Ö–ª–µ–±":             {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:17:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–ë—É–ª–æ—á–∫–∞ –¥–ª—è —Ö–æ—Ç-–¥–æ–≥/–≥–∞–º–±—É—Ä–≥–µ—Ä–∞ (World class)": {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:22:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "0:45:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–•–ª–µ–± ¬´–ì—Ä–µ—á–∏—à–Ω—ã–π¬ª":            {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:17:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–•–ª–µ–± ¬´–°—Ç–æ–ª–∏—á–Ω—ã–π¬ª":            {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:17:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"},
    "–•–ª–µ–± ¬´–ó–¥–æ—Ä–æ–≤—å–µ¬ª":             {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:18:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"},
    "–¢–æ—Å—Ç–æ–≤—ã–π —Ö–ª–µ–± –æ—Ç—Ä—É–±–Ω–æ–π –Ω–∞—Ä–µ–∑–∞–Ω–Ω—ã–π": {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:17:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–•–ª–µ–± ¬´–°–ª–∞–≤—è–Ω—Å–∫–∏–π¬ª":           {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:17:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"},
    "–ë–∞–≥–µ—Ç \"–ü—Ä–µ–º–∏—É–º\"":             {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:25:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:15:00"},
    "–ë–∞–≥–µ—Ç —Å –ª—É–∫–æ–º":               {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:20:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:18:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "0:45:00"},
    "–•–ª–µ–± ¬´–î–µ—Ä–µ–≤–µ–Ω—Å–∫–∏–π¬ª":          {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:30:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:18:30", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:30:00"},
    "–•–ª–µ–± ¬´–ë–∞–≥–µ—Ç –æ—Ç—Ä—É–±–Ω–æ–π¬ª":       {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:18:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "0:45:00"},
    "–•–ª–µ–± ¬´–î–æ–º–∞—à–Ω–∏–π¬ª":             {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:17:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"},
    "–•–ª–µ–± ¬´–ë–∞–≤–∞—Ä—Å–∫–∏–π¬ª":            {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:30:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:18:30", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:30:00"},
    "–•–ª–µ–± ¬´–û—Ç—Ä—É–±–Ω–æ–π¬ª":             {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:17:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"},
    "–•–ª–µ–± ¬´–î–∏–µ—Ç–∏—á–µ—Å–∫–∏–π¬ª":          {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:37:30", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:35:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:30:00"},
    "–•–ª–µ–± –†–∂–∞–Ω–æ–π":                 {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:30:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:18:30", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:30:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–ü–ª–µ—Ç–µ–Ω–∫–∞ —Å –ø–æ—Å—ã–ø–∫–æ–π (–º–∞–∫/–∫—É–Ω–∂—É—Ç)": {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:17:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"},
    "–ë–∞—Ç–æ–Ω ¬´–í–µ—Ä–Ω—ã–π¬ª":              {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:17:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"},
    "–•–ª–µ–± ¬´–ñ–∞–π–ª—ã¬ª":                {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:17:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"},
    "–ë—É–ª–æ—á–∫–∏":                     {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:15:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "0:30:00"}, # <<< –ù–û–í–´–ô –ü–†–û–î–£–ö–¢, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∏–ø–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    "–ë–∞—Ç–æ–Ω ¬´–ù–∞—Ä–µ–∑–Ω–æ–π¬ª":            {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:17:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"},
    "–•–ª–µ–± ¬´–ú–∏–Ω–∏ –§–æ—Ä–º–æ–≤–æ–π¬ª":         {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:12:00", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:45:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:30:00"},
    "–•–ª–µ–± ¬´–ë–æ—Ä–∏–∫–µ¬ª":               {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:20:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:16:30", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"}, # –ê–Ω–∞–ª–æ–≥ "–ë–µ—Ä–µ–∫–µ"
    "–•–ª–µ–± ¬´–õ—é–±–∏–º—ã–π¬ª, ¬´–î–µ—Ç—Å–∫–∏–π¬ª":   {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:25:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:17:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "1:00:00"},
    "–•–ª–µ–± ¬´–ë–æ—Ä–æ–¥–∏–Ω—Å–∫–∏–π¬ª":          {"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": "0:21:00", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": "0:10:30", "–§–æ—Ä–º–æ–≤–∫–∞": "0:11:00", "–†–∞—Å—Å—Ç–æ–π–∫–∞": "0:20:00", "–í—ã–ø–µ–∫–∞–Ω–∏–µ": "0:55:00", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": "2:00:00"},
} # –ò —Ç–∞–∫ –¥–∞–ª–µ–µ, –≤–µ—Å—å –≤–∞—à –±–æ–ª—å—à–æ–π —Å–ª–æ–≤–∞—Ä—å tech_map_data
machines_available = { "–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ": 2, "–°–º–µ—à–∏–≤–∞–Ω–∏–µ": 3, "–§–æ—Ä–º–æ–≤–∫–∞": 2, "–†–∞—Å—Å—Ç–æ–π–∫–∞": 8, "–í—ã–ø–µ–∫–∞–Ω–∏–µ": 6, "–û—Å—Ç—ã–≤–∞–Ω–∏–µ": 25 }
BATCH_SIZE = 100
STAGES = ["–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", "–°–º–µ—à–∏–≤–∞–Ω–∏–µ", "–§–æ—Ä–º–æ–≤–∫–∞", "–†–∞—Å—Å—Ç–æ–π–∫–∞", "–í—ã–ø–µ–∫–∞–Ω–∏–µ", "–û—Å—Ç—ã–≤–∞–Ω–∏–µ"]
MAX_WAIT_COMBINING_MIXING_MIN = 1
MAX_WAIT_MIXING_FORMING_MIN = 1
MAX_WAIT_FORMING_PROOFING_MIN = 5
MAX_WAIT_PROOFING_BAKING_MIN = 5
CRITICAL_STAGE_BEFORE_0 = "–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"
CRITICAL_STAGE_AFTER_0 = "–°–º–µ—à–∏–≤–∞–Ω–∏–µ"
CRITICAL_STAGE_BEFORE_1 = "–°–º–µ—à–∏–≤–∞–Ω–∏–µ"
CRITICAL_STAGE_AFTER_1 = "–§–æ—Ä–º–æ–≤–∫–∞"
CRITICAL_STAGE_BEFORE_2 = "–§–æ—Ä–º–æ–≤–∫–∞"
CRITICAL_STAGE_AFTER_2 = "–†–∞—Å—Å—Ç–æ–π–∫–∞"
CRITICAL_STAGE_BEFORE_3 = "–†–∞—Å—Å—Ç–æ–π–∫–∞"
CRITICAL_STAGE_AFTER_3 = "–í—ã–ø–µ–∫–∞–Ω–∏–µ"
def time_str_to_minutes_int(time_str):
    try:
        parts = list(map(int, time_str.split(':')))
        if len(parts) == 3: h, m, s = parts; return round(h * 60 + m + s / 60.0)
        elif len(parts) == 2: m, s = parts; return round(m + s / 60.0)
        else: return 0
    except: return 0

def calculate_production_schedule(orders):
    # ... (–≤–µ—Å—å –∫–æ–¥ –≤–∞—à–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ calculate_production_schedule –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
    # ... —è –µ–≥–æ —Å–∫—Ä—ã–ª –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏, –Ω–æ –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–¥–µ—Å—å ...
    tech_map_minutes_int = {}
    for product, stages_data in tech_map_data.items():
        if product not in orders or orders[product] <= 0:
            continue
        tech_map_minutes_int[product] = {}
        for stage_name in STAGES:
            time_str = stages_data.get(stage_name, "0:00:00")
            duration = time_str_to_minutes_int(time_str)
            tech_map_minutes_int[product][stage_name] = duration
    all_batches = []
    proportional_time_stages = ["–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", "–§–æ—Ä–º–æ–≤–∫–∞"]
    for product, quantity_ordered in orders.items():
        if quantity_ordered <= 0: continue
        if product not in tech_map_data:
            print(f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ü—Ä–æ–¥—É–∫—Ç '{product}' –∏–∑ –∑–∞–∫–∞–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –∫–∞—Ä—Ç–µ. –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è.")
            continue
        num_full_batches = quantity_ordered // BATCH_SIZE
        remaining_quantity = quantity_ordered % BATCH_SIZE
        total_batches_for_product = num_full_batches
        if remaining_quantity > 0: total_batches_for_product += 1
        for i in range(total_batches_for_product):
            batch_id = f"{product}_batch_{i+1}"
            is_last_partial_batch = (i == total_batches_for_product - 1) and (remaining_quantity > 0)
            current_batch_actual_size = BATCH_SIZE if not is_last_partial_batch else remaining_quantity
            batch_tasks = []
            for stage_index, stage_name in enumerate(STAGES):
                base_duration_for_100 = tech_map_minutes_int.get(product, {}).get(stage_name, 0)
                current_task_duration = base_duration_for_100
                if base_duration_for_100 > 0:
                    if is_last_partial_batch:
                        if stage_name in proportional_time_stages: current_task_duration = math.ceil(base_duration_for_100 * (current_batch_actual_size / BATCH_SIZE))
                    if current_task_duration <= 0 and base_duration_for_100 > 0: current_task_duration = 1
                    if current_task_duration > 0:
                        batch_tasks.append({ "batch_id": batch_id, "stage_index": stage_index, "stage_name": stage_name, "duration": current_task_duration, "product": product, })
            if batch_tasks: all_batches.append({"id": batch_id, "product": product, "tasks": batch_tasks})
    if not all_batches: return []
    horizon = sum(task['duration'] for batch in all_batches for task in batch['tasks'])
    min_machines = min(m_count for m_count in machines_available.values() if m_count > 0)
    if min_machines > 0: horizon = math.ceil(horizon / min_machines) * 2
    else: horizon = horizon * 2 
    horizon += 1000
    model = cp_model.CpModel()
    task_vars = collections.defaultdict(dict)
    task_lookup = {}
    for i, batch in enumerate(all_batches):
        for task in batch['tasks']:
            suffix = f'_{task["batch_id"]}_{task["stage_name"]}'
            start_var = model.NewIntVar(0, horizon, 'start' + suffix)
            end_var = model.NewIntVar(0, horizon, 'end' + suffix)
            interval_var = model.NewIntervalVar(start_var, task['duration'], end_var, 'interval' + suffix)
            task_vars[i][task['stage_index']] = (start_var, end_var, interval_var)
            task_lookup[(task['batch_id'], task['stage_name'])] = (start_var, end_var, interval_var)
    for i, batch in enumerate(all_batches):
        sorted_tasks_for_batch = sorted(batch['tasks'], key=lambda t: t['stage_index'])
        for k in range(len(sorted_tasks_for_batch) - 1):
            curr_idx = sorted_tasks_for_batch[k]['stage_index']
            next_idx = sorted_tasks_for_batch[k+1]['stage_index']
            if curr_idx in task_vars[i] and next_idx in task_vars[i]: model.Add(task_vars[i][next_idx][0] >= task_vars[i][curr_idx][1])
    for stage_index, stage_name in enumerate(STAGES):
        machine_count = machines_available.get(stage_name)
        if not machine_count or machine_count <= 0: continue
        intervals_for_stage = [task_vars[i][stage_index][2] for i, batch in enumerate(all_batches) if stage_index in task_vars[i]]
        if intervals_for_stage: model.AddCumulative(intervals_for_stage, [1] * len(intervals_for_stage), machine_count)
    critical_constraints_defined = [(CRITICAL_STAGE_BEFORE_0, CRITICAL_STAGE_AFTER_0, MAX_WAIT_COMBINING_MIXING_MIN), (CRITICAL_STAGE_BEFORE_1, CRITICAL_STAGE_AFTER_1, MAX_WAIT_MIXING_FORMING_MIN), (CRITICAL_STAGE_BEFORE_2, CRITICAL_STAGE_AFTER_2, MAX_WAIT_FORMING_PROOFING_MIN), (CRITICAL_STAGE_BEFORE_3, CRITICAL_STAGE_AFTER_3, MAX_WAIT_PROOFING_BAKING_MIN)]
    for i, batch in enumerate(all_batches):
        batch_id = batch['id']
        for stage_before, stage_after, max_wait in critical_constraints_defined:
            if stage_before in STAGES and stage_after in STAGES:
                task_before_key = (batch_id, stage_before)
                task_after_key = (batch_id, stage_after)
                if task_before_key in task_lookup and task_after_key in task_lookup: model.Add(task_lookup[task_after_key][0] - task_lookup[task_before_key][1] <= max_wait)
    makespan = model.NewIntVar(0, horizon, 'makespan')
    last_stage_tasks_ends = []
    for i, batch in enumerate(all_batches):
         if batch['tasks']:
            actual_last_stage_idx = batch['tasks'][-1]['stage_index']
            if actual_last_stage_idx in task_vars[i]: last_stage_tasks_ends.append(task_vars[i][actual_last_stage_idx][1])
    if last_stage_tasks_ends: model.AddMaxEquality(makespan, last_stage_tasks_ends)
    else: model.Add(makespan == 0)
    model.Minimize(makespan)
    solver = cp_model.CpSolver()
    status = solver.Solve(model)
    if status == cp_model.OPTIMAL or status == cp_model.FEASIBLE:
        schedule_data_for_output = []
        for i, batch in enumerate(all_batches):
            for task_info in batch['tasks']:
                stage_idx = task_info['stage_index']
                if stage_idx in task_vars[i]:
                    start_val = solver.Value(task_vars[i][stage_idx][0])
                    schedule_data_for_output.append({ "Product": task_info["product"], "Start_Time_Min": start_val })
        schedule_data_for_output.sort(key=lambda x: x['Start_Time_Min'])
        sorted_products = []
        seen_products = set()
        for task in schedule_data_for_output:
            product_name = task["Product"]
            if product_name not in seen_products:
                seen_products.add(product_name)
                sorted_products.append(product_name)
        return sorted_products
    else:
        return None

# ==============================================================================
#  –ö–û–ù–ï–¶ –ö–û–î–ê –ò–ó –í–ê–®–ï–ì–û –°–ö–†–ò–ü–¢–ê
# ==============================================================================


# --- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ API ---
@app.route('/api/orders/sort', methods=['POST'])
def sort_orders_endpoint():
    """
    –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–∏–µ–º–∞ –∑–∞–∫–∞–∑–æ–≤ –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞.
    <<< –ò–ó–ú–ï–ù–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è >>>
    """
    
    global redis_client  
    
    # 1. –ü–æ–ª—É—á–∞–µ–º JSON –∏–∑ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
    try:
        input_data = request.get_json()
        if not input_data:
            return jsonify({"error": "–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –ø—É—Å—Ç–æ–µ –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON"}), 400
        if not isinstance(input_data, list):
            return jsonify({"error": "–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º (list) JSON –æ–±—ä–µ–∫—Ç–æ–≤"}), 400
    except Exception as e:
        return jsonify({"error": "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON", "details": str(e)}), 400

    # 2. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—Ö–æ–¥–Ω–æ–π –º–∞—Å—Å–∏–≤ –≤ —Å–ª–æ–≤–∞—Ä—å, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–Ω–∏–º–∞–µ—Ç –Ω–∞—à–∞ —Ñ—É–Ω–∫—Ü–∏—è
    orders_dict = {}
    for item in input_data:
        if 'name' not in item or 'amount' not in item:
            return jsonify({"error": "–ö–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤–µ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–ª—é—á–∏ 'name' –∏ 'amount'"}), 400
        if item.get('amount') and int(item['amount']) > 0:
            product_name = item['name'].strip()
            orders_dict[product_name] = int(item['amount'])

    if not orders_dict:
        return jsonify({"message": "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ > 0).", "data": []}), 200

    # 3. <<< –ù–û–í–û–ï: –õ–æ–≥–∏–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è >>>
    sorted_product_list = None
    cache_key = None

    if redis_client:
        try:
            # –°–æ–∑–¥–∞–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è.
            # json.dumps —Å sort_keys=True –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
            # –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç –¥–∞–≤–∞—Ç—å –æ–¥–Ω—É –∏ —Ç—É –∂–µ —Å—Ç—Ä–æ–∫—É, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø–æ—Ä—è–¥–∫–∞ –∫–ª—é—á–µ–π.
            cache_key = "sort_order:" + json.dumps(orders_dict, sort_keys=True)
            
            # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ –∫–µ—à–∞
            cached_result = redis_client.get(cache_key)

            if cached_result:
                # –ö—ç—à-–•–ò–¢: –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞–π–¥–µ–Ω –≤ Redis
                print(f"‚úÖ –ö—ç—à-–•–ò–¢ –¥–ª—è –∫–ª—é—á–∞: {cache_key[:100]}...") # –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                sorted_product_list = json.loads(cached_result) # –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º –∏–∑ JSON
            else:
                # –ö—ç—à-–ü–†–û–ú–ê–•: –í Redis –Ω–∏—á–µ–≥–æ –Ω–µ—Ç
                print(f"üü° –ö—ç—à-–ü–†–û–ú–ê–• –¥–ª—è –∫–ª—é—á–∞: {cache_key[:100]}...")
        
        except redis.exceptions.RedisError as e:
            # –ï—Å–ª–∏ Redis —É–ø–∞–ª –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, —Ä–∞–±–æ—Ç–∞–µ–º –±–µ–∑ –∫–µ—à–∞
            print(f"‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Redis. –†–∞–±–æ—Ç–∞–µ–º –±–µ–∑ –∫–µ—à–∞. –û—à–∏–±–∫–∞: {e}")
            redis_client = None # –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º Redis –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

    # 4. <<< –ò–ó–ú–ï–ù–ï–ù–û: –í—ã–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É —Ä–∞—Å—á–µ—Ç–∞, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏–∑ –∫–µ—à–∞ >>>
    if sorted_product_list is None:
        print(f"üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–ª—è: {orders_dict}")
        sorted_product_list = calculate_production_schedule(orders_dict)

        # <<< –ù–û–í–û–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫–µ—à, –µ—Å–ª–∏ –æ–Ω —É—Å–ø–µ—à–Ω—ã–π >>>
        if sorted_product_list is not None and redis_client and cache_key:
            try:
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Redis –Ω–∞ 1 —á–∞—Å (3600 —Å–µ–∫—É–Ω–¥)
                redis_client.setex(
                    cache_key,
                    3600,
                    json.dumps(sorted_product_list) # –°–µ—Ä–∏–∞–ª–∏–∑—É–µ–º –≤ JSON-—Å—Ç—Ä–æ–∫—É
                )
                print(f"üíæ –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∫–ª—é—á–∞ {cache_key[:100]}... —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∫–µ—à.")
            except redis.exceptions.RedisError as e:
                print(f"‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫–µ—à Redis. –û—à–∏–±–∫–∞: {e}")


    if sorted_product_list is None:
        return jsonify({"error": "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤—ã–ø–æ–ª–Ω–∏–º–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è."}), 500

    # 5. –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç (—ç—Ç–∞ —á–∞—Å—Ç—å –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π)
    sort_order_map = {name: i + 1 for i, name in enumerate(sorted_product_list)}
    
    output_data = []
    for item in input_data:
        sort_order = sort_order_map.get(item['name'].strip())
        output_data.append({
            "sort_order": sort_order,
            "name": item['name'],
            "amount": item['amount']
        })
        
    output_data.sort(key=lambda item: (item['sort_order'] is None, item['sort_order']))
    
    print(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞. –ü–æ—Ä—è–¥–æ–∫: {sorted_product_list}")
    return jsonify(output_data)

# --- –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ ---
if __name__ == '__main__':
    print("–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://0.0.0.0:8080")
    print("–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞–∂–º–∏—Ç–µ CTRL+C")
    app.run(host='0.0.0.0', port=8080, debug=True)